<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>大四上总结 - Zecong Hu&#39;s blog</title>
  <meta name="description" content="大四了。不知不觉间就成了园子里最年长的本科生。 大一的时候看着系里的学长，觉得他们都好厉害，厉害得遥不可及。等自己到了大四，发现身边这群逗比就是现在学弟学妹眼中厉害的人。 到底是采样偏差，还是我们真的变得厉害了，只是自己没有觉得呢？ 或许二者皆有吧。 言归正传，这一学期我不在学校。是的。 但我们还是从暑研谈起吧。">

  
  <link rel="stylesheet" href="/assets/styles/core.css?v=20191121014911">
  <link rel="stylesheet" href="/assets/styles/fontello.css?v=20191121014911">
  <link rel="stylesheet" href="/assets/styles/highlighting/default.css?v=20191121014911">

  <link rel="canonical" href="http://zecong.hu/2018/07/19/my-7th-semester-in-college/">
  <link rel="alternate" type="application/rss+xml" title="Zecong Hu&#39;s blog" href="/feed.xml">

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@4/themes/light.css">
  <script src="https://unpkg.com/popper.js@1/dist/umd/popper.min.js"></script>
  <script src="https://unpkg.com/tippy.js@4/umd/index.all.min.js"></script>
  

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48327586-2', 'auto');
  ga('send', 'pageview');

</script>
  

  
</head>

  <body>

  <main class="page-content" aria-label="Content">
    
    <div id="table-of-contents">
      <div class="toc-wrapper">
        <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#暑研">暑研</a></li>
<li class="toc-entry toc-h2"><a href="#暑研contd">暑研（cont’d）</a>
<ul>
<li class="toc-entry toc-h3"><a href="#在-cmu-的三个月">在 CMU 的三个月</a></li>
<li class="toc-entry toc-h3"><a href="#回国后的一个月">回国后的一个月</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#申请">申请</a>
<ul>
<li class="toc-entry toc-h3"><a href="#项目">项目</a></li>
<li class="toc-entry toc-h3"><a href="#材料">材料</a></li>
<li class="toc-entry toc-h3"><a href="#offer">Offer</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#学习">学习</a>
<ul>
<li class="toc-entry toc-h4"><a href="#媒体计算">媒体计算</a></li>
<li class="toc-entry toc-h4"><a href="#商业伦理">商业伦理</a></li>
<li class="toc-entry toc-h4"><a href="#绿色制造与可持续发展">绿色制造与可持续发展</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#最后">最后</a></li>
</ul>
      </div>
    </div>
    

    <div class="wrapper">
      <nav class="site-nav">
  
  
  	
  	<a class="page-link" href="/" >About</a>
  	
  
  	
  	<a class="page-link" href="/index/en/index.html" >Articles</a>
  	
  
  	
  	<a class="page-link" href="/index/cn/index.html" >文章列表</a>
  	
  
  	
  
  	
  
</nav>



<article class="post" lang="zh-Hans" itemscope itemtype="http://schema.org/BlogPosting" >

  <header class="post-header">
  <a class="site-title" href="/">
  	
      Zecong Hu&#39;s blog
    
  </a>
  <h1 class="post-title" itemprop="name headline">大四上总结</h1>
</header>




  <div class="post-content" itemprop="articleBody">
    <p>大四了。不知不觉间就成了园子里最年长的本科生。</p>

<p>大一的时候看着系里的学长，觉得他们都好厉害，厉害得遥不可及。等自己到了大四，发现身边这群逗比就是现在学弟学妹眼中厉害的人。</p>

<p>到底是采样偏差，还是我们真的变得厉害了，只是自己没有觉得呢？</p>

<p>或许二者皆有吧。</p>

<p>言归正传，这一学期我不在学校。是的。</p>

<p>但我们还是从暑研谈起吧。</p>

<!--more-->

<h2 id="暑研">暑研</h2>

<p>这一年里改变了我人生轨迹的一件事，就是提交了 CMU 暑研的申请。</p>

<p>得到了暑研的机会之后，填各种各样的材料、参加替小学期的答辩、办签证、租房子，这些琐事占据了大三下的相当一部分时间。历尽千辛万苦，终于在6月27号搭上了飞往纽约的飞机，在纽瓦克转机一整晚，到了匹茨堡。</p>

<p>暑研的生活其实并不单调。我和李北辰合租了 Shadyside 的一间还不错的公寓，并在石头剪刀布的战斗中获胜，得到了较大的房间。本想趁机学学做菜，但在意识到自己厨艺堪忧，以及买厨具调料太不划算之后，打消了这个想法。工作日的时候，没有工位的几人（我、殷老师、李林翼、丁豪，和两位到现在也不知道名字的北大同学）就在 GHC 6111 <del>摸鱼</del>干活，而我工作日的起床时间也越来越向清华作息看齐。周末的时候，大家就一块出去浪。认识了这么一群玩得来的小伙伴，大概是很棒的收获了。</p>

<p>科研方面，由于一些机缘巧合选择了 Graham Neubig 作为导师，后来才知道他是 LTI 最火的教授之一。Graham 一开始给的 idea 是把后缀数据结构与神经网络结合，提升 language model 的效果（事实上一开始说的是 memory network，但到最后和这玩意一点关系也没有）。头两周还是在入门 NLP 和炼丹，之后开始看论文并实现模型。到最后做出来的东西其实就是一个有俩 predictor 的 Latent Predictor Network，一个做 span-level 的 prediction，一个做 character-level 的。结果非常平凡，原因有二：一方面模型确实能力有限，在增强表达能力的同时极大增加了计算代价；另一方面自己也没有足够的调参经验。</p>

<p>对我来说最大的收获应该是入了 NLP 的门，并发现了自己对科研的兴趣。CMU 的环境很好，实验室里的其他人也都很厉害。正是这次暑研，让我决定了毕业之后要出国读研。</p>

<h2 id="暑研contd">暑研（cont’d）</h2>

<p>本来故事到这里就该结束了。我原本的计划是，大四上一边在刘导的实验室干活，一边去 MSRA 打工。实验室的学姐建议我，与其去 MSRA，不如申请留在 CMU 接着干。</p>

<p>我觉得很有道理，也就这么做了。为此我做了一系列准备，包括：</p>

<ul>
  <li><strong>申请 DS-2019 的延期：</strong>找导师和 CMU 的 OIE 签字填表。为此还需要一份全新的财务证明原件，是从家里寄过来的。</li>
  <li><strong>找新的住处：</strong>暑假住的地方是一个学长的房子，开学之后他回来了，我得换地方住。然而开学之后房源更紧张，而且大多数不接受短租。我在 Craiglist 上整整刷了一个星期，最后找到一个愿意接受短租的房间，是一个本地老爷爷房子里的一个小房间，合租的其他三人都是 CMU 的研究生。</li>
  <li><strong>假装我还在清华：</strong>正常的操作应当是休学一学期，但对我来说行不通，因为我还有课程没修完，休学意味着延毕。所以我必须按照正常流程注册，并伪装出我还在学校的样子。这涉及到了很多问题，包括：
    <ul>
      <li><strong>注册：</strong>开学的时候我是回了一趟国的。原因有三，首先是本来就买了机票，不飞也没法退；其次是注册需要刷脸，自己刷保险一点（本来还想找在 MSRA 实习的上交同学来代我的，就算被抓到他也不会有事）；最后是想找学校的老师面谈一下推荐信的事情。</li>
      <li><strong>日常活动：</strong>我把校园卡留给了室友，让他们帮我没事刷刷门禁然后吃吃饭。</li>
      <li><strong>体测：</strong>这个是最麻烦的。幸好我有一位和我身高体重比较接近的学弟，于是拜托他帮我走完了流程。1000米直接弃跑了，总分及格了就好。</li>
      <li><strong>课程和作业：</strong>我这学期只有三门课：专业课媒体计算、双学位课商业伦理，以及一个叫绿色制造与可持续发展的文核。专业课不去上也没事；双学位课是后半学期的，找了同学帮我签到；最麻烦的是这个文核。这个课和环境保护的文核不太一样，需要有小组作业。还好我不是组长，最后也就和大家远程合作完成了作业。可没想到的是，组里其它的大四同学这么有干劲，作业被评为了优秀作业，需要进行展示。最后又是拜托那位体测学弟帮我做了展示。现在我大概欠他五顿饭。</li>
    </ul>
  </li>
</ul>

<p>必须要强调的是，这个方法是有风险的：根据学生手册，连续6周不在学校会直接被开除。虽然实际上，保密工作做得好也不会有人知道，而且同学、辅导员，和（部分）老师总的来说还是支持的。在这里必须要感谢他们，要是没有他们我可能就凉了。</p>

<h3 id="在-cmu-的三个月">在 CMU 的三个月</h3>

<p>总算是留在了 CMU 继续干活。科研方面懒得细讲，做的大概是 compositional representation 的工作，结果依然很平凡。主要想说说生活方面的事情。</p>

<p>和暑研不一样的是，小伙伴们都回国了。头几个星期大概是因为干劲比较足，还没什么感觉。接下来的两个多月里，我体会了一股前所未有的寂寞感和焦虑感。在学校的时候还好，因为大部分时间是和实验室的中国学长学姐在一块。在家里的时候，我基本上都是把自己闷在自己的小房间里，刷B站、打游戏，或者肝实验。也不止我一个人这样，另一位只身一人在 Berkeley 的同学也和我差不多。时间和国内不同步，平常和别人在网上聊天也不多。身边的人讲着另一种我无法熟练运用和表达的语言，自然感到了寂寞。</p>

<p>焦虑则来自两方面，一方面是科研没有好结果，另一方面是申请比想象中的麻烦。在这两件事都没干完的时候，就会陷入一种不知道该先干哪个，哪个也不想干的消极状态。</p>

<p>日常基本上就是学校和家两点一线的生活，不去学校的时候会在家附近吃顿好的。但到后面越来越懒，加之起床时间太晚甚至错过（午）饭点，也开始经常少吃一顿饭，一周可能有两三天不吃午饭，只有晚上一顿。晚上也睡不着，躺在床上也不干正事刷手机，结果也只能晚起。可想而知这样活干不完，于是又得靠组会前 rush。这种不健康的生活方式从第二个月开始逐渐加剧，持续到快回来的时候。</p>

<p>等熬过了12月的申请 DDL 之后，到回家也只有一周左右的时间了。这一段时间其实是最轻松的：申请能做的都做了，科研反正也就这样了。没有了焦虑，其实也就没那么寂寞了，剩下的只有似箭的归心。</p>

<h3 id="回国后的一个月">回国后的一个月</h3>

<p>终于在12月20号回到了北京。一下飞机我就约了小伙伴们晚上吃火锅。不得不说，还是中华美食文化博大精深。</p>

<p>学期剩下的日子其实很清闲了。看学生节、出去吃饭、看电影，还在新年的第一天脱了单。</p>

<p>反正，就是幸福且惬意的时光了。</p>

<h2 id="申请">申请</h2>

<p>作为大四上的重头戏，有必要单独开一章讲讲申请。</p>

<p>我没有找留学机构。留学机构能提供的服务无非是：帮着收集信息、填表、改文书。信息方面，反正也不准备申请太多项目，自己看也不会花太多时间；填表就更是了；文书的话，留学机构的人不见得写得比我好。当然，最重要的原因还是，这些机构真的太贵了。</p>

<h3 id="项目">项目</h3>

<p>首先，我觉得自己想出国读书，主要原因是想接着做一做科研。因此，我基本上只考虑了 CS 方向的 PhD 和 MS 的项目（没有考虑 MEng），并且优先了 ML/NLP 排名靠前的学校。</p>

<p>我一共申请了11个学校：</p>

<ul>
  <li>Stanford MS：斯坦福是所有人的彩票校，我自然也想碰碰运气。</li>
  <li>CMU LTI PhD/MS, MCDS：LTI 的 MS 项目其实是我的 dream program，在 CMU 实验室的学长学姐也是这个项目的。它的好处是：大概率可以拿到 funding，而且之后可以申请转 PhD。这个项目是 PhD 和 MS 一起申请的，不过直接录为 PhD 的概率极低。MCDS 其实算是 MEng 了，但是是评价比较高，课业压力比较重的一个项目，大概是能有收获的。</li>
  <li>UC Berkeley PhD/MS：一个事实是，像这种 PhD 和 MS 混申的项目，MS 的名额也非常少，所以这也是彩票。</li>
  <li>Cornell MS：这是比较特殊的一个项目，因为 Cornell（包括 Cornell Tech）主打的项目其实是 PhD 和 MEng，这个 MS 项目的规模非常小（约5人），其目的在于填补助教的空缺。因此，项目对英语要求非常高（托福口语≥28，感受一下），而且学生会被当成PhD培养，似乎还有 funding。这也是我挺想去的项目。</li>
  <li>U Washington PhD：UW 是一所 NLP 很强的学校。之所以申 PhD 是因为没有 MS 项目。</li>
  <li>NYU PhD：同上。</li>
  <li>Harvard PhD：同上。但哈佛其实在 NLP 这块并不牛逼，所以也是想试一试。</li>
  <li>UIUC MS：这是一个评价不错的 general CS MS 项目。导师其实不建议我申请 UIUC，因为这所学校厉害的是系统方向而非 ML。但总之，还是试了一下。</li>
  <li>Princeton MS：普林斯顿在理论方向很牛逼，我现在也想不通当时为什么申了这个学校。</li>
  <li>JHU PhD：JHU 位于民风淳朴的巴尔的摩。它最厉害的两个方向是医学和 NLP，所以自然也想试一试。但其实，因为巴尔的摩过于民风淳朴，我也不是很想去。</li>
  <li>Columbia PhD/MS：哥大的 MS 被大家戏称保底项目，但鉴于今年竞争极为激烈，能不能保到底也是个问题。总之试了试。</li>
</ul>

<h3 id="材料">材料</h3>

<p>首先是<strong>英语</strong>。自夸一下，我英语还是不错的，所以准备托福和 GRE 基本上没花时间。最后托福116（口语29），GRE 170/163/3.5。一个建议是能在国外考就在国外考，原因有三：一是价格会稍微便宜一些，二是考位远多于国内，三是我这辈子都不想再用国内的傻逼报名系统了。</p>

<p><strong>推荐信</strong>的话，因为我科研经历是明显不够的，因此只能拿工程经验来凑。我找了好几个老师：</p>

<ul>
  <li>我暑研的导师 Graham。他对我的评价还不错，因此他的信是最有价值的。</li>
  <li>我在清华的导师刘知远老师。比较尴尬的是，我在刘导实验室做的是工程，虽然做得还行，但和科研不怎么沾边。</li>
  <li>教授软件工程课的白晓颖老师。我提前一年修了这门课，而且取得了非常好的成绩。因此这封信也只能突出工程和团队领导力。</li>
  <li>班主任崔鹏老师。其实我和崔老师打交道不多，找崔老师要推荐信主要是为了 Cornell 的项目：我得证明自己与人沟通和表达的能力不错，曾经当过助教、班干部等等。</li>
  <li>教授数字逻辑设计的全成斌老师。这主要是为了吹嘘一下之前 FPGA 的比赛。</li>
</ul>

<p>之所以找了5位老师，是因为怕被放鸽子，而且不同的项目想突出不同方面的能力。当然，Graham 的信是每个学校都发了的。</p>

<p><strong>SOP</strong> 和 <strong>CV</strong> 参考了实验室学长学姐的模板，他们写得都非常好。我对着好几份 SOP 疯狂 overfit，然后写出了我自己的版本。前后改了很多遍，每个学校也都插了一两段不同的信息。</p>

<h3 id="offer">Offer</h3>

<p>最后拿到了三个offer：</p>

<ul>
  <li>CMU LTI MS</li>
  <li>UIUC MS</li>
  <li>Columbia MS</li>
</ul>

<p>CMU 的 offer 是出的最早的，所以我在等结果的时候完全没有心理压力。</p>

<p>UIUC 的 offer 比较有意思，我先是收到了他们的拒信，然后过了几天 Jiawei Han（群）发了邮件说祝贺你被录取，然后问对他的实验室感不感兴趣。我说我还挺有兴趣的，可我没被录取。后来他告诉我，似乎是 admission 那边没沟通好，我其实是被录取了的。</p>

<p>哥大的也比较好玩。当时已经是4月份了，身边陆续有人拿到了哥大 MS 的 offer，然而我还没有一点消息。一天收到邮件，告诉我 PhD 没录上，如果想试试MS的话就再写一份介绍。我回复说不用考虑我了谢谢，然后过几天收到了 offer，过了一会又收到邮件说以为我是要申 MS 的，无视前一封邮件就好。</p>

<p>理所当然，最后我选择了 CMU。</p>

<h2 id="学习">学习</h2>

<p>即便人不在学校，也坚持上了三门课<del>，简直是爱学习的典范</del>。</p>

<h4 id="媒体计算">媒体计算</h4>

<p>之所以留下了这门课而退了其它专业课，是因为这门课打分只看大作业，所以可以回来做。</p>

<p>但还是开始得晚了。写的时候才意识到 CG 领域发个论文有多不容易：代码太难写了。尤其是需要用户交互的，还得有 GUI。我花了好些时间捡起了大一学的 Qt，然后做了一个看着还挺炫酷（但不算分）的 GUI。最后只实现了泊松融合和 PatchMatch，给分很差。</p>

<h4 id="商业伦理">商业伦理</h4>

<p><del>双学位</del>辅修的最后一门课。和之前的商法课程是同一位老师，课程形式也是上课签到然后写感悟。于是我轮流拜托各位亲朋好友帮忙签到。</p>

<h4 id="绿色制造与可持续发展">绿色制造与可持续发展</h4>

<p>其实我对这门课一点兴趣都没有，可它是1分的文核。我原本以为这是和环境保护差不多的签到课，没想到还得写报告。课程要求每个小组设想一种绿色节能的装置，然后写成报告。我自己随便写了一段，大意是我们搞一个中央空调，根据天气、室温、用户习惯自动调整，完了还能炼炼丹。没想到同为大四的其它组员非常认真，写了很长的报告还画了图。最后我们组被评为优秀，需要做课堂展示。</p>

<p>我只好告诉他们我不在学校，然后找学弟代为展示。</p>

<h2 id="最后">最后</h2>

<p>这篇文章的前一半是和大三下总结一起写的，不知是否能看出风格上的差异。毕竟，写完毕设论文之后讲话都变得啰嗦了起来。</p>

<p>大四上对我来说就像是不存在的一个学期一样。在 CMU 的生活两点一线，我甚至没法区分10月和11月发生的事情；回到清华后则开始了养老生活，回忆起来也不觉得是学期中发生的事情。</p>

<p>当然，也只有事后的现在才能这么轻描淡写地概括这半年。</p>

<p>一如既往啰嗦了这么多。感谢你的阅读。</p>

  </div>

  <footer class="post-footer">
    <div class="post-meta">
       <time datetime="2018-07-19T03:20:00+00:00" itemprop="datePublished">Jul 19, 2018</time> 
      
    </div>

    
  </footer>

  
  <div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'http://zecong.hu/2018/07/19/my-7th-semester-in-college/';
    this.page.identifier = 'http://zecong.hu/2018/07/19/my-7th-semester-in-college/';
  };

  (function() {
    var d = document, s = d.createElement('script');

    s.src = 'https://huzecong-blog.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  
</article>

    </div>
    <script type="text/javascript">
  (function () {
    var resize = function () {
      this.width = 0.5 * (this.naturalWidth || this.width);
    }
    Array.prototype.forEach.call(document.querySelectorAll(".half-size, .retina2x"), function(el) {
      if (el.naturalWidth) {
        resize.call(el);
      } else {
        el.onload = resize;
      }
    });
  })();
</script>

  </main>

  
<script type="text/javascript">
  // Show tooltips for footnotes.
  (function() {
    const footnotes = document.querySelectorAll(".footnotes > ol > li");
    const returnMarkRegex = /("?&nbsp;<a href="#fnref:.+?" class="reversefootnote">↩(<sup>.*?<\/sup>)*<\/a>)+/s;
    const footnoteMarks = document.querySelectorAll("a.footnote");
    for (let index of footnoteMarks.keys()) {
      if (footnotes[index] === undefined) continue;
      const content = footnotes[index].innerHTML.replace(returnMarkRegex, "");
      const footnote = footnoteMarks[index];
      tippy(footnote, {
        content: content,
        arrow: true,
        animation: 'shift-away',
        interactive: true,
        theme: 'light',
        // trigger: 'click',
        size: 'large',
        touch: false,
        touchHold: true,
      });
    }
  })();
</script>



<script type="text/javascript">
  // Add "active" highlight to TOC on left.
  // Credit: https://codemyui.com/sidebar-menu-scroll-progress-indicator/
  (function() {
    const svg_html = ' \
      <svg class="toc-marker" width="200" height="200" \
           xmlns="http://www.w3.org/2000/svg"> \
        <path stroke="#444" stroke-width="1.5" fill="transparent" \
              stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" \
              stroke-linejoin="round" transform="translate(-0.5, -0.5)" /> \
      </svg> \
      '
    document.querySelector("#table-of-contents .toc-wrapper").innerHTML += svg_html;
  })();

  // Jekyll renders everything on one level, so nested titles are not actuall
  // nested in the DOM. We need to manually create the levels.
  const contentElems = document.querySelector("article > div.post-content").children;
  // A `tocItem` is a dictionary.
  const tocItems = [].slice
    .call(document.querySelectorAll("#table-of-contents li.toc-entry"))
    .map(function(item) {
      const anchor = item.querySelector("a");
      const subList = item.querySelector("ul");
      return {
        item: item,
        href: anchor.getAttribute("href").substr(1),  // remove '#' prefix
        anchor: anchor,
        subList: subList,
      };
    });
  let tocPointer = 0;
  const validTags = ["H1", "H2", "H3", "H4", "H5", "H6"];
  for (let index = 0; index < contentElems.length; ++index) {
    const elem = contentElems[index];
    if (validTags.indexOf(elem.tagName) !== -1) {
      const level = parseInt(elem.tagName[1]);

      if (tocPointer > 0 && tocPointer <= tocItems.length) {
        tocItems[tocPointer - 1].targetBottom = contentElems[index - 1];
      }

      // Current element matches the next entry in the TOC.
      if (tocPointer < tocItems.length &&
          elem.id === tocItems[tocPointer].href) {
        const curTocItem = tocItems[tocPointer];
        curTocItem.level = level;
        curTocItem.titleElem = elem;
        ++tocPointer;
      }
    }
  }
  // Final TOC items has not yet ended.
  if (tocPointer > 0 && tocPointer <= tocItems.length) {
    tocItems[tocPointer - 1].targetBottom = contentElems[contentElems.length - 1];
  }

  let pathLength;

  const tocPath = document.querySelector('.toc-marker path');

  function drawPath() {
    const path = [];
    let pathIndent,
        topOffset = 0;

    // pathLength = 100000;
    // setActivePath(currentActiveIndex);

    tocItems.forEach(function(item) {
      const x = item.anchor.offsetLeft - 5,
            height = item.anchor.offsetHeight;
      const y = topOffset;

      const parent = item.item.parentNode;
      
      if (!(parent.classList.contains("section-nav") ||
            parent.parentNode.classList.contains("expand"))) {
        // Top-level section.
        item.pathStart = 0;
        item.pathEnd = 0;
        return;
      }

      if (path.length === 0) {
        path.push( 'M', x, y, 'L', x, y + height );
        item.pathStart = 0;
      } else {
        // Draw an additional line when there's a change in
        // indent levels.
        if (pathIndent !== x) path.push('L', pathIndent, y);
        path.push('L', x, y);

        // Set the current path so that we can measure it.
        tocPath.setAttribute('d', path.join(' '));
        item.pathStart = tocPath.getTotalLength() || 0;

        path.push('L', x, y + height);
      }
      topOffset += height;

      pathIndent = x;
      tocPath.setAttribute('d', path.join(' '));
      item.pathEnd = tocPath.getTotalLength();
    });

    pathLength = tocPath.getTotalLength();
  }

  let currentActiveIndex = null;

  function setActivePath(index) {
    // Specify the visible path or hide the path altogether
    // if there are no visible items.
    if (index !== null) {
      const pathStart = tocItems[index].pathStart;
      const pathEnd = tocItems[index].pathEnd;
      if (pathEnd === 0) {
        // no-op
      } else {
        tocPath.setAttribute('stroke-dashoffset', '1');
        // Set dash end to an infinitely large value to avoid
        // accidental repetition of pattern.
        tocPath.setAttribute(
          'stroke-dasharray',
          '1, ' + pathStart + ', '+ (pathEnd - pathStart) + ', ' + 10000000);
        tocPath.setAttribute('opacity', 1);
      }
      // console.log(index, tocItems[index].href, pathStart, pathEnd, pathLength);
    } else {
      tocPath.setAttribute('opacity', 0);
    }
  }

  function setActiveEntryClass(index, className) {
    // Set CSS classes for the current index and ancestors.
    const isActive = Array(tocItems.length).fill(false);
    // Compute heights of each item after expanding here, because `scrollHeight`
    // does not take into account inner height of nested non-expanded lists that
    // will also be expanded next.
    const expandedHeights = Array(tocItems.length).fill(0);

    if (index !== null) {
      let item = tocItems[index];
      let curLevel = Infinity;
      let accumulateHeight = 0;
      for (let i = index; i >= 0; --i) {
        item = tocItems[i];
        if (item.level < curLevel) {
          curLevel = item.level;
          if (item.subList !== null)
            accumulateHeight += item.subList.scrollHeight;
          expandedHeights[i] = accumulateHeight;
          isActive[i] = true;
        }
      }
    }

    const itemsToAdd = [], itemsToRemove = [];
    const addHeights = [];
    for (let i = 0; i < tocItems.length; ++i) {
      const item = tocItems[i];
      if (item.item.classList.contains(className)) {
        if (!isActive[i]) {
          item.item.classList.remove(className);
          if (item.subList !== null) {
            itemsToRemove.push(item.subList);
          }
        }
      } else {
        if (isActive[i]) {
          item.item.classList.add(className);
          if (item.subList !== null) {
            itemsToAdd.push(item.subList);
            addHeights.push(expandedHeights[i]);
          }
        }
      }
    }

    return {
      add: itemsToAdd,
      addHeights: addHeights,
      remove: itemsToRemove,
    };
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // Ticket-based queue.
  let transitionTicket = 0, transitionCounter = 0;

  // Credit: https://css-tricks.com/using-css-transitions-auto-dimensions/
  async function toggleItems() {

    // Empty loop waiting for ticket.
    const ticket = transitionCounter++;
    while (ticket !== transitionTicket) {
      await sleep(100);
    }

    // if (ticket + 1 !== transitionCounter) {
    //   transitionTicket = ticket + 1;
    //   return;
    // }

    // Use the latest active index.
    const index = currentActiveIndex;
    itemChanges = setActiveEntryClass(index, "expand");

    if (itemChanges.add.length === 0 && itemChanges.remove.length === 0) {
      // if (ticket + 1 === transitionCounter) {
        // Only perform callback on final ticket.
        // drawPath();
        setActivePath(index);
      // }
      // Null transition, release ticket.
      transitionTicket = ticket + 1;
      return;
    }

    const firstItem = (itemChanges.add.length > 0 ?
                       itemChanges.add[0] : itemChanges.remove[0]);
    const originalTransition = firstItem.style.transition;
    const allItems = itemChanges.add.concat(itemChanges.remove);

    const targetHeight = itemChanges.addHeights;
    allItems.forEach(item => item.style.transition = "");
    for (let item of itemChanges.add) {
      item.style.height = "0";
    }
    for (let item of itemChanges.remove) {
      item.style.height = item.scrollHeight + "px";
    }
    firstItem.offsetHeight;  // trigger reflow

    requestAnimationFrame(function() {
      for (let i = 0; i < itemChanges.add.length; ++i) {
        const item = itemChanges.add[i];
        item.style.height = targetHeight[i] + "px";
      }
      for (let i = 0; i < itemChanges.remove.length; ++i) {
        const item = itemChanges.remove[i];
        item.style.height = "0";
      }
      allItems.forEach(item => item.style.transition = originalTransition);
      firstItem.offsetHeight;  // trigger reflow

      firstItem.addEventListener('transitionend', function(e) {
        // Event listeners are also fired for children nodes.
        if (e.target !== firstItem) return;
        e.target.removeEventListener(e.type, arguments.callee);
        for (let item of itemChanges.add) {
          item.style.height = "auto";
        }
        for (let item of itemChanges.remove) {
          item.style.height = null;
        }
        firstItem.offsetHeight;  // trigger reflow

        // End of transition, release ticket.
        transitionTicket = ticket + 1;
      });

      drawPath();
      setActivePath(index);
    });
  }

  function updateActive(event, forceRedraw = false) {
    const windowHeight = window.innerHeight;

    // We only allow one entry to be active. This entry must satisfy one of the
    // following conditions:
    // 1. Its section is the only section visible on screen.
    // 2. Its title (`targetTop`) is the first title that is within screen bounds.
    const titlePos = tocItems.map(function(item) {
      return item.titleElem.getBoundingClientRect();
    });
    const targetBottom = tocItems.map(function(item) {
      return item.targetBottom.getBoundingClientRect().bottom;
    });

    let index = 0;
    for (; index < tocItems.length; ++index) {
      if (// Any portion of title is within screen bounds.
          (0 < titlePos[index].bottom && titlePos[index].top < windowHeight) ||
          // Section is the only one on screen...
          (titlePos[index].top < 0 &&
            // ... and is the final section.
           ((index === tocItems.length - 1 &&
             targetBottom[index] > 0) ||
            // ... and the next section title is not completely shown.
            (index < tocItems.length - 1 &&
             titlePos[index + 1].bottom > windowHeight)))) {
        break;
      }
    }
    if (index >= tocItems.length) index = null;

    if (currentActiveIndex !== index || forceRedraw) {
      // console.log("redraw", currentActiveIndex, index, forceRedraw);
      currentActiveIndex = index;

      // setActivePath(index);
      setActiveEntryClass(index, "active");

      requestAnimationFrame(function() {
        toggleItems();
      });
    }
  }

  drawPath();
  updateActive(true);
  window.addEventListener('resize', function(event) {
    updateActive(event, true);
  }, false);
  window.addEventListener('scroll', updateActive, false);
</script>


<footer class="site-footer">

  <div class="wrapper">
    <div class="social-links">
      
      <a class="social-link social-github" href="https://github.com/huzecong">
        <i class="icon-github"></i>
      </a>
      
      
      
      <a class="social-link social-rss" href="/feed.xml" target="_blank">
        <i class="icon-rss"></i>
      </a>
    </div>
    <div class="credits">
      KAGAMI, made with <i class="icon-heart"></i> by Kamikat
    </div>
  </div>

</footer>


</body>

</html>
